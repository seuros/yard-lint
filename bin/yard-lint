#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift File.expand_path('../lib', __dir__)

require 'optparse'
require 'yard-lint'

options = {}
config_file = nil

OptionParser.new do |opts|
  opts.banner = 'Usage: yard-lint [options] PATH'

  opts.on('-c', '--config FILE', 'Path to config file (default: .yard-lint.yml)') do |file|
    config_file = file
  end

  opts.on('-f', '--format FORMAT', 'Output format (text, json)') do |format|
    options[:format] = format
  end

  opts.on('-q', '--quiet', 'Quiet mode (only show summary)') do
    options[:quiet] = true
  end

  opts.on('--stats', 'Show statistics summary') do
    options[:stats] = true
  end

  opts.on('--[no-]progress', 'Show progress indicator (default: auto)') do |value|
    options[:progress] = value
  end

  opts.on('-v', '--version', 'Show version') do
    puts "yard-lint #{Yard::Lint::VERSION}"
    exit
  end

  opts.on('-h', '--help', 'Show this help') do
    puts opts
    exit
  end
end.parse!

# Get path argument
path = ARGV[0]

unless path
  puts 'Error: PATH argument is required'
  puts 'Usage: yard-lint [options] PATH'
  exit 1
end

# Clear YARD database and command cache to ensure fresh run on each CLI invocation
#
# Why this is necessary:
#
# 1. **Command Cache Reset** (`reset_command_cache!`)
#    - The command cache stores results from YARD commands across validator instances
#    - This cache is shared at the class level (Base.@shared_command_cache)
#    - Without reset: Results from a previous CLI run could leak into the current run
#    - Critical for CLI: Each `yard-lint` invocation should start with clean state
#    - Not needed in-process: Within a single run, caching YARD results is beneficial
#
# 2. **YARD Database Clear** (`clear_yard_database!`)
#    - YARD creates temp database directories for parsing documentation
#    - Directories are isolated per-argument-set using SHA256 hash (see base.rb:84-97)
#    - Base temp dir (YARDOC_BASE_TEMP_DIR) persists across CLI invocations
#    - Without clear: Old databases accumulate in /tmp, wasting disk space
#    - Database isolation prevents contamination within a single run, but doesn't
#      clean up between runs
#
# In summary: These ensure each CLI invocation is independent and doesn't leak state
# from previous runs, while also preventing temp directory accumulation.
Yard::Lint::Validators::Base.reset_command_cache!
Yard::Lint::Validators::Base.clear_yard_database!

# Run the linter with config_file (it will be loaded internally)
result = Yard::Lint.run(
  path: path,
  config_file: config_file,
  progress: options[:progress]
)

# Format and display results
case options[:format]
when 'json'
  require 'json'
  puts JSON.pretty_generate({
    offense_count: result.count,
    offenses: result.offenses
  })
  exit result.exit_code
when 'text', nil
  if result.clean?
    puts 'No offenses found'
    exit 0
  else
    # Show statistics if requested or in quiet mode
    if options[:stats] || options[:quiet]
      stats = result.statistics
      puts "\n#{result.count} offense(s) detected"
      puts "  Errors:      #{stats[:error]}"
      puts "  Warnings:    #{stats[:warning]}"
      puts "  Conventions: #{stats[:convention]}"
      puts
    end

    # Show individual offenses unless in quiet mode
    unless options[:quiet]
      puts "Found #{result.count} offense(s):\n\n"

      result.offenses.each do |offense|
        severity_symbol = case offense[:severity]
                          when 'error' then 'E'
                          when 'warning' then 'W'
                          when 'convention' then 'C'
                          else '?'
                          end

        puts "[#{severity_symbol}] #{offense[:location]}:#{offense[:location_line]}"
        puts "    #{offense[:name]}: #{offense[:message]}"
        puts
      end
    end

    exit result.exit_code
  end
else
  puts "Error: Unknown format '#{options[:format]}'"
  exit 1
end
